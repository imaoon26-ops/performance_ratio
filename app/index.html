<!DOCTYPE html>
<html lang="th">

<head>
  <meta charset="UTF-8">
  <title>Performance Ratio Dashboard (‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô + ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô)</title>
  <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel='stylesheet' href='style.css'>
  <style>
    .filters-section {
      margin: 20px 0;
    }
    #filters {
      display: flex;
      flex-direction: row;
      flex-wrap: wrap;
      gap: 20px;
      justify-content: space-between;
      align-items: flex-end;
    }
    .filter-group {
      flex: 1;
      min-width: 200px;
      background-color: transparent;
      padding: 0;
      border-radius: 0;
      box-shadow: none;
    }
    .filter-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #333;
    }
    .filter-group input,
    .filter-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
      background-color: #fff;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }
    .filter-group input:focus,
    .filter-group select:focus {
      border-color: #007bff;
      outline: none;
    }
    @media (max-width: 768px) {
      #filters {
        justify-content: center;
      }
      .filter-group {
        min-width: 45%;
      }
    }
    @media (max-width: 480px) {
      #filters {
        flex-direction: column;
        align-items: stretch;
        gap: 15px;
      }
      .filter-group {
        min-width: auto;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <header>
      <h2>üìä Performance Ratio Dashboard</h2>
      <p>‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏ã‡∏•‡∏≤‡∏£‡πå‡πÄ‡∏ã‡∏•‡∏•‡πå‡πÅ‡∏ö‡∏ö‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</p>
    </header>

    <main>
      <div class="upload-section" style="align-items: center; display: flex">
        <div class="upload-card">
          <label><span class="icon">üìÅ</span>Upload Performance File</label>
          <input type="file" id="excelFile" accept=".xlsx, .xls">
          <div class="file-status" id="performanceStatus"></div>
        </div>

        <div class="upload-card">
          <label><span class="icon">‚òÄÔ∏è</span>Upload Solar Database</label>
          <input type="file" id="solarDBFile" accept=".xlsx, .xls">
          <div class="file-status" id="solarDBStatus"></div>
        </div>
      </div>

      <div class="filters-section">
        <div id="filters">
          <div class="filter-group">
            <label>‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î:</label>
            <input list="provinceList" id="provinceInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î...">
            <datalist id="provinceList"></datalist>
          </div>

          <div class="filter-group">
            <label>‡∏≠‡∏≥‡πÄ‡∏†‡∏≠:</label>
            <input list="districtList" id="districtInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏≥‡πÄ‡∏†‡∏≠...">
            <datalist id="districtList"></datalist>
          </div>

          <div class="filter-group">
            <label>‡∏ï‡∏≥‡∏ö‡∏•:</label>
            <input list="tumbolList" id="tumbolInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≥‡∏ö‡∏•...">
            <datalist id="tumbolList"></datalist>
          </div>

          <div class="filter-group">
            <label for="monthSelect">‡πÄ‡∏î‡∏∑‡∏≠‡∏ô:</label>
            <select id="monthSelect">
              <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô --</option>
              <option value="0">‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°</option>
              <option value="1">‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå</option>
              <option value="2">‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°</option>
              <option value="3">‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô</option>
              <option value="4">‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°</option>
              <option value="5">‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô</option>
              <option value="6">‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°</option>
              <option value="7">‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°</option>
              <option value="8">‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô</option>
              <option value="9">‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°</option>
              <option value="10">‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô</option>
              <option value="11">‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°</option>
              <option value="all">‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ</option>
            </select>
          </div>

          <div class="filter-group">
            <label>‡∏Ñ‡πà‡∏≤ Hi ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏≠‡∏á (kWh / m¬≤):</label>
            <input type="number" step="0.01" id="customHi" placeholder="‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏Å‡∏≥‡∏´‡∏ô‡∏î ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•">
          </div>
        </div>
      </div>

      <div class="calculate-btn">
        <button id="calcBtn">
          <span class="icon">üìä</span>‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Performance Ratio
        </button>
      </div>

      <div class="result-section">
        <div id="hiResult" class="result-box">‡∏Ñ‡πà‡∏≤ Hi (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô): -</div>
      </div>

      <div class="charts-section">
        <div class="chart-container">
          <canvas id="dailyChart" height="300"></canvas>
        </div>
        <div class="chart-container">
          <canvas id="monthlyChart" height="300"></canvas>
        </div>
      </div>
    </main>
  </div>

  <script>
    let solarDB = [];
    let dailyChart, monthlyChart;
    let performanceData = [];

    const thaiMonthNames = [
      "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô",
      "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°"
    ];

    window.addEventListener("error", e => {
      console.error("‚ùå Global JS Error:", e.message, e.filename, e.lineno);
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå: " + e.message);
    });

    // ===== LOAD SOLAR DB =====
    document.getElementById("solarDBFile").addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      console.log("üì• Loading solar DB:", file.name);
      const reader = new FileReader();
      reader.onload = ev => {
        try {
          const data = new Uint8Array(ev.target.result);
          const workbook = XLSX.read(data, { type: "array" });
          const sheet = workbook.Sheets[workbook.SheetNames[0]];
          solarDB = XLSX.utils.sheet_to_json(sheet);
          console.log("‚úÖ Solar DB loaded:", solarDB.length, "rows");
          populateProvinceList();
          document.getElementById("solarDBStatus").textContent = `‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${solarDB.length} ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏•‡πâ‡∏ß`;
          document.getElementById("solarDBStatus").classList.add("valid");
        } catch (err) {
          console.error("‚ùå Solar DB load error:", err);
          alert("‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Solar DB ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        }
      };
      reader.readAsArrayBuffer(file);
    });


    function populateProvinceList() {
      const provinces = [...new Set(solarDB.map(r => r["Province"]))].sort();
      document.getElementById("provinceList").innerHTML = provinces.map(p => `<option value="${p}">`).join('');
      console.log("üó∫ Provinces:", provinces.slice(0, 5), "...");
    }

    document.getElementById("provinceInput").addEventListener("input", e => {
      const province = e.target.value;
      const districts = [...new Set(solarDB.filter(r => r["Province"] === province).map(r => r["District"]))].sort();
      document.getElementById("districtList").innerHTML = districts.map(d => `<option value="${d}">`).join('');
      console.log("üèô Districts for", province, ":", districts.length);
    });

    document.getElementById("districtInput").addEventListener("input", e => {
      const province = document.getElementById("provinceInput").value;
      const district = e.target.value;
      const tumbols = [...new Set(solarDB.filter(r => r["Province"] === province && r["District"] === district).map(r => r["Tumbol"]))].sort();
      document.getElementById("tumbolList").innerHTML = tumbols.map(t => `<option value="${t}">`).join('');
      console.log("üèò Tumbols for", district, ":", tumbols.length);
    });


    // ===== [FIXED] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Å‡∏≤‡∏£‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì Hi =====
    function findHi(province, district, tumbol, monthIndex) {
      if (!solarDB || !solarDB.length) {
        console.warn("‚ö†Ô∏è solarDB is empty");
        return null;
      }
      const clean = v => (v || "").toString().trim().toLowerCase();

      const row = solarDB.find(r =>
        clean(r["Province"]) === clean(province) &&
        clean(r["District"] ) === clean(district) &&
        clean(r["Tumbol"]) === clean(tumbol)
      );

      if (!row) {
        console.warn("‚ùå No matching row found for", province, district, tumbol);
        return null;
      }

      const monthMap = {
        0: ["january", "‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°", "jan"],
        1: ["february", "‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå", "feb"],
        2: ["march", "‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°", "mar"],
        3: ["april", "‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô", "apr"],
        4: ["may", "‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°"],
        5: ["june", "‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô", "jun"],
        6: ["july", "‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°", "jul"],
        7: ["august", "‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°", "aug"],
        8: ["september", "‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô", "sep"],
        9: ["october", "‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°", "oct"],
        10: ["november", "‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô", "nov"],
        11: ["december", "‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°", "dec"]
      };

      let hiMJ = null;
      let matchedKey = "";

      if (monthIndex === "all") {
        hiMJ = parseFloat(
          row["Annually"] || row["Annual"] || row["Anually"] || row["Annualy"] || 0
        );
        matchedKey = "Annual";
      } else {
        const possibleKeys = monthMap[parseInt(monthIndex)] || [];
        const keysInRow = Object.keys(row);

        for (const key of keysInRow) {
          const cleanKey = key.trim().toLowerCase();
          for (const target of possibleKeys) {
            if (cleanKey.includes(target.toLowerCase())) {
              matchedKey = key;
              hiMJ = parseFloat(row[key]);
              break;
            }
          }
          if (hiMJ) break;
        }
      }

      if (!hiMJ || isNaN(hiMJ)) {
        console.warn("‚ö†Ô∏è No valid Hi found for month:", monthIndex);
        return null;
      }

      const hiKWh = hiMJ * 0.2777778;

      console.log(`[DEBUG] hiMJ=${hiMJ}, hiKWh=${hiKWh}`);
      return hiKWh; 
    }

    
    function updateHi() {
        const p = document.getElementById("provinceInput").value;
        const d = document.getElementById("districtInput").value;
        const t = document.getElementById("tumbolInput").value;
        const m = document.getElementById("monthSelect").value;
        const customHi = parseFloat(document.getElementById("customHi").value) || null;
        console.log("üîÑ updateHi triggered", { p, d, t, m });
        if (p && d && t && m !== "") {
            let hi = findHi(p, d, t, m === "all" ? "all" : parseInt(m));
            if (customHi) hi = customHi;
            document.getElementById("hiResult").textContent =
                hi ? `‡∏Ñ‡πà‡∏≤ Hi(‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô): ${ hi.toFixed(2) } kWh / m¬≤` : "‚ùå ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•";
        }
    }


    document.getElementById("excelFile").addEventListener("change", e => {
        const file = e.target.files[0];
        if (!file) return;
        console.log("üì• Loading performance file:", file.name);
        const reader = new FileReader();
        reader.onload = event => {
            try {
                const data = new Uint8Array(event.target.result);
                const workbook = XLSX.read(data, { type: "array" });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                performanceData = XLSX.utils.sheet_to_json(firstSheet);
                console.log("‚úÖ Performance data loaded:", performanceData.length, "rows");
                document.getElementById("performanceStatus").textContent = `‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${ performanceData.length } ‡πÅ‡∏ñ‡∏ß‡πÅ‡∏•‡πâ‡∏ß`;
                document.getElementById("performanceStatus").classList.add("valid");
            } catch (err) {
                console.error("‚ùå Performance load error:", err);
                alert("‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå Performance ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
            }
        };
        reader.readAsArrayBuffer(file);
    });


    // ===== [FIXED] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç logic ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• =====
    document.getElementById("calcBtn").addEventListener("click", () => {
        console.log("üöÄ Calculate button clicked");
        if (!performanceData.length) {
            alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î Performance File ‡∏Å‡πà‡∏≠‡∏ô");
            return;
        }
        const selectedMonth = document.getElementById("monthSelect").value;

        drawPRCharts(performanceData, selectedMonth);
    });

    // ===== [FIXED] ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç logic ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• =====
    function drawPRCharts(allRows, selectedMonth) {
        console.log("üìà drawPRCharts with", allRows.length, "rows", "for month", selectedMonth);
        try {
            const dailyLabels = [];
            const dailyPRs = [];
            const monthlyData = {}; // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö PR ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô

            const p = document.getElementById("provinceInput").value;
            const d = document.getElementById("districtInput").value;
            const t = document.getElementById("tumbolInput").value;

            const customHi = parseFloat(document.getElementById("customHi").value) || null;

            // ‡∏™‡∏£‡πâ‡∏≤‡∏á Hi Cache (‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏Ñ‡πà‡∏≤ Hi ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô kWH/m¬≤/day)
            const hiCache = {};
            for (let m = 0; m < 12; m++) {
                const hiVal = findHi(p, d, t, m);
                if (hiVal && !isNaN(hiVal)) hiCache[m] = hiVal;
            }
            if (customHi && selectedMonth !== "" && selectedMonth !== "all") {
              hiCache[parseInt(selectedMonth)] = customHi;
            }
            console.log("‚òÄÔ∏è Hi Cache (Daily Yr):", hiCache);

            allRows.forEach((row, i) => {
                const normalizedRow = {};
                Object.keys(row).forEach(k => {
                    normalizedRow[k.trim().replace(/\s+/g, " ")] = row[k];
                });

                const Po = parseFloat(String(normalizedRow["Po (kWp)"] || normalizedRow["Po"] || "").replace(/,/g, ""));
                const Egrid = parseFloat(String(normalizedRow["Egrid (kWh)"] || normalizedRow["E-Grid (kWh)"] || normalizedRow["Egrid"] || "").replace(/,/g, ""));
                const dateStr = normalizedRow["date"] || normalizedRow["‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà"];
                if (isNaN(Po) || isNaN(Egrid) || !dateStr) {
                    console.warn("‚ö†Ô∏è Skip row (missing Po/Egrid/date):", i, normalizedRow);
                    return;
                }

                const dObj = new Date(dateStr);
                if (isNaN(dObj.getTime())) {
                    console.warn("‚ö†Ô∏è Invalid date:", dateStr);
                    return;
                }

                const monthIndex = dObj.getMonth();
                const Hi_this = hiCache[monthIndex];
                if (!Hi_this || isNaN(Hi_this)) {
                    console.warn("‚ö†Ô∏è No Hi for row:", i, "month=", monthIndex);
                    return;
                }

                const Yf = Egrid / Po;
                const Yr = Hi_this;
                const PR = (Yf / Yr) * 100;

                if (isNaN(PR)) {
                    console.warn("‚ö†Ô∏è PR is NaN:", { Yf, Yr, row });
                    return;
                }

                // [FIXED] ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô
                if (selectedMonth === "all" || monthIndex === parseInt(selectedMonth)) {
                    dailyLabels.push(dObj.toISOString().split("T")[0]);
                    dailyPRs.push(PR);
                }

                // [FIXED] ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (‡πÄ‡∏Å‡πá‡∏ö‡∏ó‡∏∏‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡πÄ‡∏™‡∏°‡∏≠)
                const monthKey = `${ dObj.getFullYear() } - ${ dObj.getMonth() + 1 }`;
                if (!monthlyData[monthKey]) monthlyData[monthKey] = [];
                monthlyData[monthKey].push(PR);
            });

            console.log("‚úÖ Daily PR count (filtered):", dailyPRs.length);
            console.log("‚úÖ Monthly data keys (all):", Object.keys(monthlyData));

            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏£‡∏≤‡∏ü‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô)
            if (dailyPRs.length === 0 && selectedMonth !== "" && selectedMonth !== "all") {
                alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ô Performance File");
                // ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢‡∏Å‡∏£‡∏≤‡∏ü‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
                if (dailyChart) dailyChart.destroy();
            } else {
                drawDailyChart(dailyLabels, dailyPRs);
            }

            // ‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô
            const monthlyLabels = Object.keys(monthlyData).sort((a, b) => new Date(a) - new Date(b)).map(key => {
                const [y, m] = key.split("-");
                return `${ thaiMonthNames[m - 1]} ${ y }`;
            });
            const monthlyPRs = Object.keys(monthlyData).sort((a, b) => new Date(a) - new Date(b)).map(key => {
                const arr = monthlyData[key];
                return arr.reduce((a, b) => a + b, 0) / arr.length;
            });

            console.log("‚úÖ Monthly PRs (calculated):", monthlyPRs);

            if (monthlyPRs.length > 0) {
                drawMonthlyChart(monthlyLabels, monthlyPRs);
            } else if (allRows.length > 0) {
                alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì PR ‡πÑ‡∏î‡πâ, ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå Performance (‡πÄ‡∏ä‡πà‡∏ô Po, Egrid, date)");
                if (monthlyChart) monthlyChart.destroy();
            }

        } catch (err) {
            console.error("‚ùå Error in drawPRCharts:", err, err.stack);
            alert("Error in drawPRCharts: " + err.message);
        }
    }


    // ===== CHARTS (‡∏™‡πà‡∏ß‡∏ô‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç) =====
    function drawDailyChart(labels, data) {
        console.log("üìä Drawing daily chart:", labels.length, "points");
        const ctx = document.getElementById("dailyChart").getContext("2d");
        if (dailyChart) dailyChart.destroy();
        dailyChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels,
                datasets: [{
                    label: 'PR ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô (%)',
                    data,
                    borderColor: '#00A859',
                    backgroundColor: 'rgba(0,168,89,0.15)',
                    fill: true,
                    tension: 0.35,
                    pointRadius: 3,
                    pointBackgroundColor: '#0072BC',
                    borderWidth: 2
                }]
            },
            options: {
                plugins: {
                    title: { display: true, text: 'Performance Ratio ‡∏£‡∏≤‡∏¢‡∏ß‡∏±‡∏ô', font: { size: 16 } },
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'PR (%)' } },
                    x: { ticks: { maxRotation: 90, minRotation: 45 } }
                }
            }
        });
    }

    function drawMonthlyChart(labels, data) {
        console.log("üìä Drawing monthly chart:", labels.length, "bars");
        const ctx = document.getElementById("monthlyChart").getContext("2d");
        if (monthlyChart) monthlyChart.destroy();
        const palette = [
            '#00A859', '#0072BC', '#9BCB3B', '#78BE20', '#006838', '#29ABE2', '#8DC63F', '#00573D'
        ];
        const colors = data.map((_, i) => palette[i % palette.length]);
        monthlyChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels,
                datasets: [{
                    label: 'PR ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (%)',
                    data,
                    backgroundColor: colors,
                    borderRadius: 6
                }]
            },
            options: {
                plugins: {
                    title: { display: true, text: 'Performance Ratio ‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô', font: { size: 16 } },
                    legend: { display: false }
                },
                scales: {
                    y: { beginAtZero: true, title: { display: true, text: 'PR (%)' } }
                }
            }
        });
    }

    document.getElementById("tumbolInput").addEventListener("input", updateHi);
    document.getElementById("monthSelect").addEventListener("change", updateHi);
    document.getElementById("customHi").addEventListener("input", updateHi);
  </script>

</body>

</html>