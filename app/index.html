<!DOCTYPE html>
<html lang="th">

<head>
    ┬а
    <meta charset="UTF-8">
    ┬а <title>Performance Ratio Dashboard (р╕гр╕▓р╕вр╕зр╕▒р╕Щ + р╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ)</title>
    ┬а
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    ┬а
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    ┬а
    <link rel='stylesheet' href='style.css'>
</head>

<body>
    ┬а <div class="container">
        ┬а ┬а <header>
            ┬а ┬а ┬а <h2>ЁЯУК Performance Ratio Dashboard</h2>
            ┬а ┬а ┬а <p>р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕Ыр╕гр╕░р╕кр╕┤р╕Чр╕Шр╕┤р╕ар╕▓р╕Юр╕гр╕░р╕Ър╕Ър╣Вр╕Лр╕ер╕▓р╕гр╣Мр╣Ар╕Лр╕ер╕ер╣Мр╣Бр╕Ър╕Ър╕гр╕▓р╕вр╕зр╕▒р╕Щр╣Бр╕ер╕░р╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ</p>
            ┬а ┬а </header>

        ┬а ┬а <main>
            ┬а ┬а ┬а <div class="upload-section" style="align-items: center; display: flex">
                ┬а ┬а ┬а ┬а <div class="upload-card">
                    ┬а ┬а ┬а ┬а ┬а <label><span class="icon">ЁЯУБ</span>Upload Performance File</label>
                    ┬а ┬а ┬а ┬а ┬а <input type="file" id="excelFile" accept=".xlsx, .xls">
                    ┬а ┬а ┬а ┬а ┬а <div class="file-status" id="performanceStatus"></div>
                    ┬а ┬а ┬а ┬а </div>

                ┬а ┬а ┬а ┬а <div class="upload-card">
                    ┬а ┬а ┬а ┬а ┬а <label><span class="icon">тШАя╕П</span>Upload Solar Database</label>
                    ┬а ┬а ┬а ┬а ┬а <input type="file" id="solarDBFile" accept=".xlsx, .xls">
                    ┬а ┬а ┬а ┬а ┬а <div class="file-status" id="solarDBStatus"></div>
                    ┬а ┬а ┬а ┬а </div>
                ┬а ┬а ┬а </div>

            ┬а ┬а ┬а <div class="filters-section">
                ┬а ┬а ┬а ┬а <div id="filters">
                    ┬а ┬а ┬а ┬а ┬а <div class="filter-group">
                        ┬а ┬а ┬а ┬а ┬а ┬а <label>р╕Ир╕▒р╕Зр╕лр╕зр╕▒р╕Ф:</label>
                        ┬а ┬а ┬а ┬а ┬а ┬а <input list="provinceList" id="provinceInput" placeholder="р╕Юр╕┤р╕бр╕Юр╣Мр╕Кр╕╖р╣Ир╕нр╕Ир╕▒р╕Зр╕лр╕зр╕▒р╕Ф...">
                        ┬а ┬а ┬а ┬а ┬а ┬а <datalist id="provinceList"></datalist>
                        ┬а ┬а ┬а ┬а ┬а </div>

                    ┬а ┬а ┬а ┬а ┬а <div class="filter-group">
                        ┬а ┬а ┬а ┬а ┬а ┬а <label>р╕нр╕│р╣Ар╕ар╕н:</label>
                        ┬а ┬а ┬а ┬а ┬а ┬а <input list="districtList" id="districtInput" placeholder="р╕Юр╕┤р╕бр╕Юр╣Мр╕Кр╕╖р╣Ир╕нр╕нр╕│р╣Ар╕ар╕н...">
                        ┬а ┬а ┬а ┬а ┬а ┬а <datalist id="districtList"></datalist>
                        ┬а ┬а ┬а ┬а ┬а </div>

                    ┬а ┬а ┬а ┬а ┬а <div class="filter-group">
                        ┬а ┬а ┬а ┬а ┬а ┬а <label>р╕Хр╕│р╕Ър╕е:</label>
                        ┬а ┬а ┬а ┬а ┬а ┬а <input list="tumbolList" id="tumbolInput" placeholder="р╕Юр╕┤р╕бр╕Юр╣Мр╕Кр╕╖р╣Ир╕нр╕Хр╕│р╕Ър╕е...">
                        ┬а ┬а ┬а ┬а ┬а ┬а <datalist id="tumbolList"></datalist>
                        ┬а ┬а ┬а ┬а ┬а </div>

                    ┬а ┬а ┬а ┬а ┬а <div class="filter-group">
                        ┬а ┬а ┬а ┬а ┬а ┬а <label for="monthSelect">р╣Ар╕Фр╕╖р╕нр╕Щ:</label>
                        ┬а ┬а ┬а ┬а ┬а ┬а <select id="monthSelect">
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="">-- р╣Ар╕ер╕╖р╕нр╕Бр╣Ар╕Фр╕╖р╕нр╕Щ --</option>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="0">р╕бр╕Бр╕гр╕▓р╕Др╕б</option>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="1">р╕Бр╕╕р╕бр╕ар╕▓р╕Юр╕▒р╕Щр╕Шр╣М</option>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="2">р╕бр╕╡р╕Щр╕▓р╕Др╕б</option>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="3">р╣Ар╕бр╕йр╕▓р╕вр╕Щ</option>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="4">р╕Юр╕др╕йр╕ар╕▓р╕Др╕б</option>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="5">р╕бр╕┤р╕Цр╕╕р╕Щр╕▓р╕вр╕Щ</option>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="6">р╕Бр╕гр╕Бр╕Ор╕▓р╕Др╕б</option>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="7">р╕кр╕┤р╕Зр╕лр╕▓р╕Др╕б</option>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="8">р╕Бр╕▒р╕Щр╕вр╕▓р╕вр╕Щ</option>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="9">р╕Хр╕╕р╕ер╕▓р╕Др╕б</option>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="10">р╕Юр╕др╕ир╕Ир╕┤р╕Бр╕▓р╕вр╕Щ</option>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="11">р╕Шр╕▒р╕Щр╕зр╕▓р╕Др╕б</option>
                            ┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="all">р╕Чр╕▒р╣Йр╕Зр╕Ыр╕╡</option>
                            ┬а ┬а ┬а ┬а ┬а ┬а </select>
                        ┬а ┬а ┬а ┬а ┬а </div>
                    ┬а ┬а ┬а ┬а </div>
                ┬а ┬а ┬а </div>

            ┬а ┬а ┬а <div class="calculate-btn">
                ┬а ┬а ┬а ┬а <button id="calcBtn">
                    ┬а ┬а ┬а ┬а ┬а <span class="icon">ЁЯУК</span>р╕Др╕│р╕Щр╕зр╕У Performance Ratio
                    ┬а ┬а ┬а ┬а </button>
                ┬а ┬а ┬а </div>

            ┬а ┬а ┬а <div class="result-section">
                ┬а ┬а ┬а ┬а ┬а ┬а <div id="hiResult" class="result-box">р╕Др╣Ир╕▓ Hi (р╣Ар╕Йр╕ер╕╡р╣Ир╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ): -</div>
                ┬а ┬а ┬а </div>

            ┬а ┬а ┬а <div class="charts-section">
                ┬а ┬а ┬а ┬а <div class="chart-container">
                    ┬а ┬а ┬а ┬а ┬а <canvas id="dailyChart" height="300"></canvas>
                    ┬а ┬а ┬а ┬а </div>
                ┬а ┬а ┬а ┬а <div class="chart-container">
                    ┬а ┬а ┬а ┬а ┬а <canvas id="monthlyChart" height="300"></canvas>
                    ┬а ┬а ┬а ┬а </div>
                ┬а ┬а ┬а </div>
            ┬а ┬а </main>
        ┬а </div>
    ┬а
    <script>
        let solarDB = [];
        let dailyChart, monthlyChart;
        let performanceData = [];

        const monthNames = [
            "January", "February", "March", "April", "May", "June",
            "July", "August", "September", "October", "November", "December"
        ];

        window.addEventListener("error", e => {
            console.error("тЭМ Global JS Error:", e.message, e.filename, e.lineno);
            alert("р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣М: " + e.message);
        });

        // ===== LOAD SOLAR DB =====
        document.getElementById("solarDBFile").addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;
            console.log("ЁЯУе Loading solar DB:", file.name);
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const data = new Uint8Array(ev.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    solarDB = XLSX.utils.sheet_to_json(sheet);
                    console.log("тЬЕ Solar DB loaded:", solarDB.length, "rows");
                    populateProvinceList();
                    document.getElementById("solarDBStatus").textContent = `тЬЕ р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕е ${solarDB.length} р╣Бр╕Цр╕зр╣Бр╕ер╣Йр╕з`;
                    document.getElementById("solarDBStatus").classList.add("valid");
                } catch (err) {
                    console.error("тЭМ Solar DB load error:", err);
                    alert("р╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣М Solar DB р╣Др╕бр╣Ир╕кр╕│р╣Ар╕гр╣Зр╕И");
                }
            };
            reader.readAsArrayBuffer(file);
        });


        function populateProvinceList() {
            const provinces = [...new Set(solarDB.map(r => r["Province"]))].sort();
            document.getElementById("provinceList").innerHTML = provinces.map(p => `<option value="${p}">`).join('');
            console.log("ЁЯЧ║ Provinces:", provinces.slice(0, 5), "...");
        }

        document.getElementById("provinceInput").addEventListener("input", e => {
            const province = e.target.value;
            const districts = [...new Set(solarDB.filter(r => r["Province"] === province).map(r => r["District"]))].sort();
            document.getElementById("districtList").innerHTML = districts.map(d => `<option value="${d}">`).join('');
            console.log("ЁЯПЩ Districts for", province, ":", districts.length);
        });

        document.getElementById("districtInput").addEventListener("input", e => {
            const province = document.getElementById("provinceInput").value;
            const district = e.target.value;
            const tumbols = [...new Set(solarDB.filter(r => r["Province"] === province && r["District"] === district).map(r => r["Tumbol"]))].sort();
            document.getElementById("tumbolList").innerHTML = tumbols.map(t => `<option value="${t}">`).join('');
            console.log("ЁЯПШ Tumbols for", district, ":", tumbols.length);
        });


        // ===== [FIXED] р╣Бр╕Бр╣Йр╣Др╕Вр╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕У Hi =====
        function findHi(province, district, tumbol, monthIndex) {
            if (!solarDB || !solarDB.length) {
                console.warn("тЪая╕П solarDB is empty");
                return null;
            }
            const clean = v => (v || "").toString().trim().toLowerCase();

            const row = solarDB.find(r =>
                clean(r["Province"]) === clean(province) &&
                clean(r["District"]) === clean(district) &&
                clean(r["Tumbol"]) === clean(tumbol)
            );

            if (!row) {
                console.warn("тЭМ No matching row found for", province, district, tumbol);
                return null;
            }

            const monthMap = {
                0: ["january", "р╕бр╕Бр╕гр╕▓р╕Др╕б", "jan"],
                1: ["february", "р╕Бр╕╕р╕бр╕ар╕▓р╕Юр╕▒р╕Щр╕Шр╣М", "feb"],
                2: ["march", "р╕бр╕╡р╕Щр╕▓р╕Др╕б", "mar"],
                3: ["april", "р╣Ар╕бр╕йр╕▓р╕вр╕Щ", "apr"],
                4: ["may", "р╕Юр╕др╕йр╕ар╕▓р╕Др╕б"],
                5: ["june", "р╕бр╕┤р╕Цр╕╕р╕Щр╕▓р╕вр╕Щ", "jun"],
                6: ["july", "р╕Бр╕гр╕Бр╕Ор╕▓р╕Др╕б", "jul"],
                7: ["august", "р╕кр╕┤р╕Зр╕лр╕▓р╕Др╕б", "aug"],
                8: ["september", "р╕Бр╕▒р╕Щр╕вр╕▓р╕вр╕Щ", "sep"],
                9: ["october", "р╕Хр╕╕р╕ер╕▓р╕Др╕б", "oct"],
                10: ["november", "р╕Юр╕др╕ир╕Ир╕┤р╕Бр╕▓р╕вр╕Щ", "nov"],
                11: ["december", "р╕Шр╕▒р╕Щр╕зр╕▓р╕Др╕б", "dec"]
            };

            let hiMJ = null;
            let matchedKey = "";

            if (monthIndex === "all") {
                hiMJ = parseFloat(
                    row["Annually"] || row["Annual"] || row["Anually"] || row["Annualy"] || 0
                );
                matchedKey = "Annual";
            } else {
                const possibleKeys = monthMap[parseInt(monthIndex)] || [];
                const keysInRow = Object.keys(row);

                // console.log(`ЁЯФН [DEBUG] Searching for monthIndex=${monthIndex} тЖТ`, possibleKeys);
                // console.log(`ЁЯЧЭ Available keys in this row:`, keysInRow);

                for (const key of keysInRow) {
                    const cleanKey = key.trim().toLowerCase();
                    for (const target of possibleKeys) {
                        if (cleanKey.includes(target.toLowerCase())) {
                            matchedKey = key;
                            hiMJ = parseFloat(row[key]);
                            break;
                        }
                    }
                    if (hiMJ) break;
                }
            }

            if (!hiMJ || isNaN(hiMJ)) {
                console.warn("тЪая╕П No valid Hi found for month:", monthIndex);
                return null;
            }

            // [FIXED] р╕ер╕Ър╕Бр╕▓р╕гр╕Др╕╣р╕У daysInMonth р╕нр╕нр╕Б р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Йр╣Др╕Фр╣Йр╕Др╣Ир╕▓р╣Ар╕Йр╕ер╕╡р╣Ир╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ (Yr)
            // const daysInMonth = monthIndex === "all"
            // ? 365
            // : new Date(2025, parseInt(monthIndex) + 1, 0).getDate();

            const correction = 1.08; // р╕Ыр╕гр╕▒р╕Ъ calibrate р╕Хр╕▓р╕бр╕Юр╕╖р╣Йр╕Щр╕Чр╕╡р╣Ир╕Ир╕гр╕┤р╕З

            // [FIXED] р╕Др╕│р╕Щр╕зр╕Ур╣Ар╕Ыр╣Зр╕Щ kWh/m┬▓/day
            const hiKWh = hiMJ * 0.27778 * correction;

            // [FIXED] р╣Бр╕Бр╣Йр╣Др╕В log
            // ┬а ┬а console.log(`тШАя╕П Found Hi from "${matchedKey}" = ${hiMJ} MJ/m┬▓/day ├Ч 0.27778 ├Ч ${correction} = ${hiKWh.toFixed(2)} kWh/m┬▓/day`);
            console.log(`[DEBUG] hiMJ=${hiMJ}, correction=${correction}, hiKWh=${hiMJ * 0.27778 * correction}`);
            return hiKWh;
        }

        // ===== [FIXED] р╣Бр╕Бр╣Йр╣Др╕Вр╕Ыр╣Йр╕▓р╕вр╕Бр╕│р╕Бр╕▒р╕Ър╕лр╕Щр╣Ир╕зр╕в =====
        function updateHi() {
            const p = document.getElementById("provinceInput").value;
            const d = document.getElementById("districtInput").value;
            const t = document.getElementById("tumbolInput").value;
            const m = document.getElementById("monthSelect").value;
            console.log("ЁЯФД updateHi triggered", { p, d, t, m });
            if (p && d && t && m !== "") {
                const hi = findHi(p, d, t, m === "all" ? "all" : parseInt(m));
                document.getElementById("hiResult").textContent =
                    hi ? `р╕Др╣Ир╕▓ Hi (р╣Ар╕Йр╕ер╕╡р╣Ир╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ): ${hi.toFixed(2)} kWh/m┬▓` : "тЭМ р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е";
            }
        }


        document.getElementById("excelFile").addEventListener("change", e => {
            const file = e.target.files[0];
            if (!file) return;
            console.log("ЁЯУе Loading performance file:", file.name);
            const reader = new FileReader();
            reader.onload = event => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: "array" });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    performanceData = XLSX.utils.sheet_to_json(firstSheet);
                    console.log("тЬЕ Performance data loaded:", performanceData.length, "rows");
                    document.getElementById("performanceStatus").textContent = `тЬЕ р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕е ${performanceData.length} р╣Бр╕Цр╕зр╣Бр╕ер╣Йр╕з`;
                    document.getElementById("performanceStatus").classList.add("valid");
                } catch (err) {
                    console.error("тЭМ Performance load error:", err);
                    alert("р╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣М Performance р╣Др╕бр╣Ир╕кр╕│р╣Ар╕гр╣Зр╕И");
                }
            };
            reader.readAsArrayBuffer(file);
        });


        // ===== [FIXED] р╣Бр╕Бр╣Йр╣Др╕В logic р╕Бр╕▓р╕гр╕Бр╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е =====
        document.getElementById("calcBtn").addEventListener("click", () => {
            console.log("ЁЯЪА Calculate button clicked");
            if (!performanceData.length) {
                alert("р╕Бр╕гр╕╕р╕Ур╕▓р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф Performance File р╕Бр╣Ир╕нр╕Щ");
                return;
            }
            const selectedMonth = document.getElementById("monthSelect").value;

            // [FIXED] р╕ер╕Ър╕Бр╕▓р╕гр╕Бр╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Хр╕гр╕Зр╕Щр╕╡р╣Й
            // р╣Ар╕гр╕▓р╕Ир╕░р╕кр╣Ир╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф (performanceData) р╣Др╕Ыр╣Гр╕лр╣Й drawPRCharts
            // р╣Бр╕ер╕░р╕кр╣Ир╕З selectedMonth р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Й drawPRCharts р╕Бр╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕гр╕▓р╕Яр╕гр╕▓р╕вр╕зр╕▒р╕Щр╣Ар╕нр╕З

            // [FIXED] р╕кр╣Ир╕З performanceData (р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф) р╣Бр╕ер╕░ selectedMonth
            drawPRCharts(performanceData, selectedMonth);
        });

        // ===== [FIXED] р╣Бр╕Бр╣Йр╣Др╕В logic р╕Бр╕▓р╕гр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╣Бр╕ер╕░р╕Бр╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е =====
        function drawPRCharts(allRows, selectedMonth) {
            console.log("ЁЯУИ drawPRCharts with", allRows.length, "rows", "for month", selectedMonth);
            try {
                const dailyLabels = [];
                const dailyPRs = [];
                const monthlyData = {}; // р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Ар╕Бр╣Зр╕Ъ PR р╕гр╕▓р╕вр╕зр╕▒р╕Щр╕Вр╕нр╕Зр╣Бр╕Хр╣Ир╕ер╕░р╣Ар╕Фр╕╖р╕нр╕Щ

                const p = document.getElementById("provinceInput").value;
                const d = document.getElementById("districtInput").value;
                const t = document.getElementById("tumbolInput").value;

                // р╕кр╕гр╣Йр╕▓р╕З Hi Cache (р╕Хр╕нр╕Щр╕Щр╕╡р╣Йр╕Ир╕░р╣Ар╕Бр╣Зр╕Ър╕Др╣Ир╕▓ Hi р╣Ар╕Йр╕ер╕╡р╣Ир╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ kWH/m┬▓/day)
                const hiCache = {};
                for (let m = 0; m < 12; m++) {
                    const hiVal = findHi(p, d, t, m);
                    if (hiVal && !isNaN(hiVal)) hiCache[m] = hiVal;
                }
                console.log("тШАя╕П Hi Cache (Daily Yr):", hiCache);

                // [FIXED] р╕ер╕Ър╕Бр╕▓р╕гр╕Бр╕гр╕нр╕Зр╕Лр╣Йр╕│р╕Лр╣Йр╕нр╕Щ
                // р╣Ар╕гр╕▓р╕Ир╕░р╕зр╕Щр╕ер╕╣р╕Ыр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф (allRows)

                allRows.forEach((row, i) => {
                    const normalizedRow = {};
                    Object.keys(row).forEach(k => {
                        normalizedRow[k.trim().replace(/\s+/g, " ")] = row[k];
                    });

                    const Po = parseFloat(String(normalizedRow["Po (kWp)"] || normalizedRow["Po"] || "").replace(/,/g, ""));
                    const Egrid = parseFloat(String(normalizedRow["Egrid (kWh)"] || normalizedRow["E-Grid (kWh)"] || normalizedRow["Egrid"] || "").replace(/,/g, ""));
                    const dateStr = normalizedRow["date"] || normalizedRow["р╕зр╕▒р╕Щр╕Чр╕╡р╣И"];
                    if (!Po || !Egrid || !dateStr) {
                        console.warn("тЪая╕П Skip row (missing Po/Egrid/date):", i, normalizedRow);
                        return;
                    }

                    const dObj = new Date(dateStr);
                    if (isNaN(dObj)) return;

                    const monthIndex = dObj.getMonth(); // 0тАУ11
                    const Hi_this = hiCache[monthIndex]; // р╕Щр╕╡р╣Ир╕Др╕╖р╕н Yr (Daily Hi)
                    if (!Hi_this || isNaN(Hi_this)) {
                        console.warn("тЪая╕П No Hi for row:", i, "month=", monthIndex);
                        return;
                    }

                    const Yf = Egrid / Po;
                    const Yr = Hi_this; // [FIXED] Yr р╕Др╕╖р╕нр╕Др╣Ир╕▓ Hi р╣Ар╕Йр╕ер╕╡р╣Ир╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ
                    const PR = (Yf / Yr) * 100;

                    if (isNaN(PR)) {
                        console.warn("тЪая╕П PR is NaN:", { Yf, Yr, row });
                        return;
                    }

                    // [FIXED] р╕Бр╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕гр╕▓р╕Яр╕гр╕▓р╕вр╕зр╕▒р╕Щ
                    if (selectedMonth === "all" || monthIndex === parseInt(selectedMonth)) {
                        dailyLabels.push(dObj.toISOString().split("T")[0]);
                        dailyPRs.push(PR);
                    }

                    // [FIXED] р╣Ар╕Бр╣Зр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕гр╕▓р╕Яр╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ (р╣Ар╕Бр╣Зр╕Ър╕Чр╕╕р╕Бр╣Ар╕Фр╕╖р╕нр╕Щр╣Ар╕кр╕бр╕н)
                    const monthKey = `${dObj.getFullYear()}-${dObj.getMonth() + 1}`;
                    if (!monthlyData[monthKey]) monthlyData[monthKey] = [];
                    monthlyData[monthKey].push(PR);
                });

                console.log("тЬЕ Daily PR count (filtered):", dailyPRs.length);
                console.log("тЬЕ Monthly data keys (all):", Object.keys(monthlyData));

                // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕│р╕лр╕гр╕▒р╕Ър╣Ар╕Фр╕╖р╕нр╕Щр╕Чр╕╡р╣Ир╣Ар╕ер╕╖р╕нр╕Бр╕лр╕гр╕╖р╕нр╣Др╕бр╣И (р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕гр╕▓р╕Яр╕гр╕▓р╕вр╕зр╕▒р╕Щ)
                if (dailyPRs.length === 0 && selectedMonth !== "" && selectedMonth !== "all") {
                    alert("р╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Вр╕нр╕Зр╣Ар╕Фр╕╖р╕нр╕Щр╕Чр╕╡р╣Ир╣Ар╕ер╕╖р╕нр╕Бр╣Гр╕Щ Performance File");
                    // р╕Чр╕│р╕ер╕▓р╕вр╕Бр╕гр╕▓р╕Яр╣Ар╕Бр╣Ир╕▓ (р╕Цр╣Йр╕▓р╕бр╕╡)
                    if (dailyChart) dailyChart.destroy();
                } else {
                    drawDailyChart(dailyLabels, dailyPRs);
                }

                // р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╕Вр╣Йр╕нр╕бр╕╣р╕ер╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ
                const monthlyLabels = Object.keys(monthlyData).sort((a, b) => new Date(a) - new Date(b)).map(key => {
                    const [y, m] = key.split("-");
                    return `${monthNames[m - 1]} ${y}`;
                });
                const monthlyPRs = Object.keys(monthlyData).sort((a, b) => new Date(a) - new Date(b)).map(key => {
                    const arr = monthlyData[key];
                    return arr.reduce((a, b) => a + b, 0) / arr.length;
                });

                console.log("тЬЕ Monthly PRs (calculated):", monthlyPRs);

                if (monthlyPRs.length > 0) {
                    drawMonthlyChart(monthlyLabels, monthlyPRs);
                } else if (allRows.length > 0) {
                    alert("р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Др╕│р╕Щр╕зр╕У PR р╣Др╕Фр╣Й, р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щр╣Др╕Яр╕ер╣М Performance (р╣Ар╕Кр╣Ир╕Щ Po, Egrid, date)");
                    if (monthlyChart) monthlyChart.destroy();
                }

            } catch (err) {
                console.error("тЭМ Error in drawPRCharts:", err, err.stack);
                alert("Error in drawPRCharts: " + err.message);
            }
        }


        // ===== CHARTS (р╕кр╣Ир╕зр╕Щр╕Щр╕╡р╣Йр╣Др╕бр╣Ир╕Хр╣Йр╕нр╕Зр╣Бр╕Бр╣Йр╣Др╕В) =====
        function drawDailyChart(labels, data) {
            console.log("ЁЯУК Drawing daily chart:", labels.length, "points");
            const ctx = document.getElementById("dailyChart").getContext("2d");
            if (dailyChart) dailyChart.destroy();
            dailyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [{
                        label: 'PR р╕гр╕▓р╕вр╕зр╕▒р╕Щ (%)',
                        data,
                        borderColor: '#00A859',
                        backgroundColor: 'rgba(0,168,89,0.15)',
                        fill: true,
                        tension: 0.35,
                        pointRadius: 3,
                        pointBackgroundColor: '#0072BC',
                        borderWidth: 2
                    }]
                },
                options: {
                    plugins: {
                        title: { display: true, text: 'Performance Ratio р╕гр╕▓р╕вр╕зр╕▒р╕Щ', font: { size: 16 } },
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'PR (%)' } },
                        x: { ticks: { maxRotation: 90, minRotation: 45 } }
                    }
                }
            });
        }

        function drawMonthlyChart(labels, data) {
            console.log("ЁЯУК Drawing monthly chart:", labels.length, "bars");
            const ctx = document.getElementById("monthlyChart").getContext("2d");
            if (monthlyChart) monthlyChart.destroy();
            const palette = [
                '#00A859', '#0072BC', '#9BCB3B', '#78BE20', '#006838', '#29ABE2', '#8DC63F', '#00573D'
            ];
            const colors = data.map((_, i) => palette[i % palette.length]);
            monthlyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'PR р╣Ар╕Йр╕ер╕╡р╣Ир╕вр╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ (%)',
                        data,
                        backgroundColor: colors,
                        borderRadius: 6
                    }]
                },
                options: {
                    plugins: {
                        title: { display: true, text: 'Performance Ratio р╣Ар╕Йр╕ер╕╡р╣Ир╕вр╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ', font: { size: 16 } },
                        legend: { display: false }
                    },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'PR (%)' } }
                    }
                }
            });
        }

        document.getElementById("tumbolInput").addEventListener("input", updateHi);
        document.getElementById("monthSelect").addEventListener("change", updateHi);
    </script>

</body>

</html>