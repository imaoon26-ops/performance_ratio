<!DOCTYPE html>
<html lang="th">

<head>
┬а <meta charset="UTF-8">
┬а <title>Performance Ratio Dashboard (р╕гр╕▓р╕вр╕зр╕▒р╕Щ + р╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ)</title>
┬а <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
┬а <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
┬а <link rel='stylesheet' href='style.css'>
</head>

<body>
┬а <div class="container">
┬а ┬а <header>
┬а ┬а ┬а <h2>ЁЯУК Performance Ratio Dashboard</h2>
┬а ┬а ┬а <p>р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕Ыр╕гр╕░р╕кр╕┤р╕Чр╕Шр╕┤р╕ар╕▓р╕Юр╕гр╕░р╕Ър╕Ър╣Вр╕Лр╕ер╕▓р╕гр╣Мр╣Ар╕Лр╕ер╕ер╣Мр╣Бр╕Ър╕Ър╕гр╕▓р╕вр╕зр╕▒р╕Щр╣Бр╕ер╕░р╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ</p>
┬а ┬а </header>

┬а ┬а <main>
┬а ┬а ┬а <div class="upload-section">
┬а ┬а ┬а ┬а <div class="upload-card">
┬а ┬а ┬а ┬а ┬а <label><span class="icon">ЁЯУБ</span>Upload Performance File</label>
┬а ┬а ┬а ┬а ┬а <input type="file" id="excelFile" accept=".xlsx, .xls">
┬а ┬а ┬а ┬а ┬а <div class="file-status" id="performanceStatus"></div>
┬а ┬а ┬а ┬а </div>

┬а ┬а ┬а ┬а <div class="upload-card">
┬а ┬а ┬а ┬а ┬а <label><span class="icon">тШАя╕П</span>Upload Solar Database</label>
┬а ┬а ┬а ┬а ┬а <input type="file" id="solarDBFile" accept=".xlsx, .xls">
┬а ┬а ┬а ┬а ┬а <div class="file-status" id="solarDBStatus"></div>
┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а </div>

┬а ┬а ┬а <div class="filters-section">
┬а ┬а ┬а ┬а <div id="filters">
┬а ┬а ┬а ┬а ┬а <div class="filter-group">
┬а ┬а ┬а ┬а ┬а ┬а <label>р╕Ир╕▒р╕Зр╕лр╕зр╕▒р╕Ф:</label>
┬а ┬а ┬а ┬а ┬а ┬а <input list="provinceList" id="provinceInput" placeholder="р╕Юр╕┤р╕бр╕Юр╣Мр╕Кр╕╖р╣Ир╕нр╕Ир╕▒р╕Зр╕лр╕зр╕▒р╕Ф...">
┬а ┬а ┬а ┬а ┬а ┬а <datalist id="provinceList"></datalist>
┬а ┬а ┬а ┬а ┬а </div>

┬а ┬а ┬а ┬а ┬а <div class="filter-group">
┬а ┬а ┬а ┬а ┬а ┬а <label>р╕нр╕│р╣Ар╕ар╕н:</label>
┬а ┬а ┬а ┬а ┬а ┬а <input list="districtList" id="districtInput" placeholder="р╕Юр╕┤р╕бр╕Юр╣Мр╕Кр╕╖р╣Ир╕нр╕нр╕│р╣Ар╕ар╕н...">
┬а ┬а ┬а ┬а ┬а ┬а <datalist id="districtList"></datalist>
┬а ┬а ┬а ┬а ┬а </div>

┬а ┬а ┬а ┬а ┬а <div class="filter-group">
┬а ┬а ┬а ┬а ┬а ┬а <label>р╕Хр╕│р╕Ър╕е:</label>
┬а ┬а ┬а ┬а ┬а ┬а <input list="tumbolList" id="tumbolInput" placeholder="р╕Юр╕┤р╕бр╕Юр╣Мр╕Кр╕╖р╣Ир╕нр╕Хр╕│р╕Ър╕е...">
┬а ┬а ┬а ┬а ┬а ┬а <datalist id="tumbolList"></datalist>
┬а ┬а ┬а ┬а ┬а </div>

┬а ┬а ┬а ┬а ┬а <div class="filter-group">
┬а ┬а ┬а ┬а ┬а ┬а <label for="monthSelect">р╣Ар╕Фр╕╖р╕нр╕Щ:</label>
┬а ┬а ┬а ┬а ┬а ┬а <select id="monthSelect">
┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="">-- р╣Ар╕ер╕╖р╕нр╕Бр╣Ар╕Фр╕╖р╕нр╕Щ --</option>
┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="0">р╕бр╕Бр╕гр╕▓р╕Др╕б</option>
┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="1">р╕Бр╕╕р╕бр╕ар╕▓р╕Юр╕▒р╕Щр╕Шр╣М</option>
┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="2">р╕бр╕╡р╕Щр╕▓р╕Др╕б</option>
┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="3">р╣Ар╕бр╕йр╕▓р╕вр╕Щ</option>
┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="4">р╕Юр╕др╕йр╕ар╕▓р╕Др╕б</option>
┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="5">р╕бр╕┤р╕Цр╕╕р╕Щр╕▓р╕вр╕Щ</option>
┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="6">р╕Бр╕гр╕Бр╕Ор╕▓р╕Др╕б</option>
┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="7">р╕кр╕┤р╕Зр╕лр╕▓р╕Др╕б</option>
┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="8">р╕Бр╕▒р╕Щр╕вр╕▓р╕вр╕Щ</option>
┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="9">р╕Хр╕╕р╕ер╕▓р╕Др╕б</option>
┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="10">р╕Юр╕др╕ир╕Ир╕┤р╕Бр╕▓р╕вр╕Щ</option>
┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="11">р╕Шр╕▒р╕Щр╕зр╕▓р╕Др╕б</option>
┬а ┬а ┬а ┬а ┬а ┬а ┬а <option value="all">р╕Чр╕▒р╣Йр╕Зр╕Ыр╕╡</option>
┬а ┬а ┬а ┬а ┬а ┬а </select>
┬а ┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а </div>

┬а ┬а ┬а <div class="calculate-btn">
┬а ┬а ┬а ┬а <button id="calcBtn">
┬а ┬а ┬а ┬а ┬а <span class="icon">ЁЯУК</span>р╕Др╕│р╕Щр╕зр╕У Performance Ratio
┬а ┬а ┬а ┬а </button>
┬а ┬а ┬а </div>

┬а ┬а ┬а <div class="result-section">
┬а ┬а ┬а ┬а ┬а ┬а ┬а ┬а <div id="hiResult" class="result-box">р╕Др╣Ир╕▓ Hi (р╣Ар╕Йр╕ер╕╡р╣Ир╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ): -</div>
┬а ┬а ┬а </div>

┬а ┬а ┬а <div class="charts-section">
┬а ┬а ┬а ┬а <div class="chart-container">
┬а ┬а ┬а ┬а ┬а <canvas id="dailyChart" height="300"></canvas>
┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а ┬а <div class="chart-container">
┬а ┬а ┬а ┬а ┬а <canvas id="monthlyChart" height="300"></canvas>
┬а ┬а ┬а ┬а </div>
┬а ┬а ┬а </div>
┬а ┬а </main>
┬а </div>
┬а <script>
┬а ┬а let solarDB = [];
┬а ┬а let dailyChart, monthlyChart;
┬а ┬а let performanceData = [];

┬а ┬а const monthNames = [
┬а ┬а ┬а "January", "February", "March", "April", "May", "June",
┬а ┬а ┬а "July", "August", "September", "October", "November", "December"
┬а ┬а ];

┬а ┬а window.addEventListener("error", e => {
┬а ┬а ┬а console.error("тЭМ Global JS Error:", e.message, e.filename, e.lineno);
┬а ┬а ┬а alert("р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕кр╕Др╕гр╕┤р╕Ыр╕Хр╣М: " + e.message);
┬а ┬а });

┬а ┬а // ===== LOAD SOLAR DB =====
┬а ┬а document.getElementById("solarDBFile").addEventListener("change", e => {
┬а ┬а ┬а const file = e.target.files[0];
┬а ┬а ┬а if (!file) return;
┬а ┬а ┬а console.log("ЁЯУе Loading solar DB:", file.name);
┬а ┬а ┬а const reader = new FileReader();
┬а ┬а ┬а reader.onload = ev => {
┬а ┬а ┬а ┬а try {
┬а ┬а ┬а ┬а ┬а const data = new Uint8Array(ev.target.result);
┬а ┬а ┬а ┬а ┬а const workbook = XLSX.read(data, { type: "array" });
┬а ┬а ┬а ┬а ┬а const sheet = workbook.Sheets[workbook.SheetNames[0]];
┬а ┬а ┬а ┬а ┬а solarDB = XLSX.utils.sheet_to_json(sheet);
┬а ┬а ┬а ┬а ┬а console.log("тЬЕ Solar DB loaded:", solarDB.length, "rows");
┬а ┬а ┬а ┬а ┬а populateProvinceList();
┬а ┬а ┬а ┬а ┬а document.getElementById("solarDBStatus").textContent = `тЬЕ р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕е ${solarDB.length} р╣Бр╕Цр╕зр╣Бр╕ер╣Йр╕з`;
┬а ┬а ┬а ┬а ┬а document.getElementById("solarDBStatus").classList.add("valid");
┬а ┬а ┬а ┬а } catch (err) {
┬а ┬а ┬а ┬а ┬а console.error("тЭМ Solar DB load error:", err);
┬а ┬а ┬а ┬а ┬а alert("р╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣М Solar DB р╣Др╕бр╣Ир╕кр╕│р╣Ар╕гр╣Зр╕И");
┬а ┬а ┬а ┬а }
┬а ┬а ┬а };
┬а ┬а ┬а reader.readAsArrayBuffer(file);
┬а ┬а });

┬а ┬а┬а
┬а ┬а function populateProvinceList() {
┬а ┬а ┬а const provinces = [...new Set(solarDB.map(r => r["Province"]))].sort();
┬а ┬а ┬а document.getElementById("provinceList").innerHTML = provinces.map(p => `<option value="${p}">`).join('');
┬а ┬а ┬а console.log("ЁЯЧ║ Provinces:", provinces.slice(0, 5), "...");
┬а ┬а }

┬а ┬а document.getElementById("provinceInput").addEventListener("input", e => {
┬а ┬а ┬а const province = e.target.value;
┬а ┬а ┬а const districts = [...new Set(solarDB.filter(r => r["Province"] === province).map(r => r["District"]))].sort();
┬а ┬а ┬а document.getElementById("districtList").innerHTML = districts.map(d => `<option value="${d}">`).join('');
┬а ┬а ┬а console.log("ЁЯПЩ Districts for", province, ":", districts.length);
┬а ┬а });

┬а ┬а document.getElementById("districtInput").addEventListener("input", e => {
┬а ┬а ┬а const province = document.getElementById("provinceInput").value;
┬а ┬а ┬а const district = e.target.value;
┬а ┬а ┬а const tumbols = [...new Set(solarDB.filter(r => r["Province"] === province && r["District"] === district).map(r => r["Tumbol"]))].sort();
┬а ┬а ┬а document.getElementById("tumbolList").innerHTML = tumbols.map(t => `<option value="${t}">`).join('');
┬а ┬а ┬а console.log("ЁЯПШ Tumbols for", district, ":", tumbols.length);
┬а ┬а });

┬а┬а
// ===== [FIXED] р╣Бр╕Бр╣Йр╣Др╕Вр╕Бр╕▓р╕гр╕Др╕│р╕Щр╕зр╕У Hi =====
function findHi(province, district, tumbol, monthIndex) {
┬а if (!solarDB || !solarDB.length) {
┬а ┬а console.warn("тЪая╕П solarDB is empty");
┬а ┬а return null;
┬а }
┬а const clean = v => (v || "").toString().trim().toLowerCase();

┬а const row = solarDB.find(r =>
┬а ┬а clean(r["Province"]) === clean(province) &&
┬а ┬а clean(r["District"]) === clean(district) &&
┬а ┬а clean(r["Tumbol"]) === clean(tumbol)
┬а );

┬а if (!row) {
┬а ┬а console.warn("тЭМ No matching row found for", province, district, tumbol);
┬а ┬а return null;
┬а }

┬а const monthMap = {
┬а ┬а 0: ["january", "р╕бр╕Бр╕гр╕▓р╕Др╕б", "jan"],
┬а ┬а 1: ["february", "р╕Бр╕╕р╕бр╕ар╕▓р╕Юр╕▒р╕Щр╕Шр╣М", "feb"],
┬а ┬а 2: ["march", "р╕бр╕╡р╕Щр╕▓р╕Др╕б", "mar"],
┬а ┬а 3: ["april", "р╣Ар╕бр╕йр╕▓р╕вр╕Щ", "apr"],
┬а ┬а 4: ["may", "р╕Юр╕др╕йр╕ар╕▓р╕Др╕б"],
┬а ┬а 5: ["june", "р╕бр╕┤р╕Цр╕╕р╕Щр╕▓р╕вр╕Щ", "jun"],
┬а ┬а 6: ["july", "р╕Бр╕гр╕Бр╕Ор╕▓р╕Др╕б", "jul"],
┬а ┬а 7: ["august", "р╕кр╕┤р╕Зр╕лр╕▓р╕Др╕б", "aug"],
┬а ┬а 8: ["september", "р╕Бр╕▒р╕Щр╕вр╕▓р╕вр╕Щ", "sep"],
┬а ┬а 9: ["october", "р╕Хр╕╕р╕ер╕▓р╕Др╕б", "oct"],
┬а ┬а 10: ["november", "р╕Юр╕др╕ир╕Ир╕┤р╕Бр╕▓р╕вр╕Щ", "nov"],
┬а ┬а 11: ["december", "р╕Шр╕▒р╕Щр╕зр╕▓р╕Др╕б", "dec"]
┬а };

┬а let hiMJ = null;
┬а let matchedKey = "";

┬а if (monthIndex === "all") {
┬а ┬а hiMJ = parseFloat(
┬а ┬а ┬а row["Annually"] || row["Annual"] || row["Anually"] || row["Annualy"] || 0
┬а ┬а );
┬а ┬а matchedKey = "Annual";
┬а } else {
┬а ┬а const possibleKeys = monthMap[parseInt(monthIndex)] || [];
┬а ┬а const keysInRow = Object.keys(row);

┬а ┬а // console.log(`ЁЯФН [DEBUG] Searching for monthIndex=${monthIndex} тЖТ`, possibleKeys);
┬а ┬а // console.log(`ЁЯЧЭ Available keys in this row:`, keysInRow);

┬а ┬а for (const key of keysInRow) {
┬а ┬а ┬а const cleanKey = key.trim().toLowerCase();
┬а ┬а ┬а for (const target of possibleKeys) {
┬а ┬а ┬а ┬а if (cleanKey.includes(target.toLowerCase())) {
┬а ┬а ┬а ┬а ┬а matchedKey = key;
┬а ┬а ┬а ┬а ┬а hiMJ = parseFloat(row[key]);
┬а ┬а ┬а ┬а ┬а break;
┬а ┬а ┬а ┬а }
┬а ┬а ┬а }
┬а ┬а ┬а if (hiMJ) break;
┬а ┬а }
┬а }

┬а if (!hiMJ || isNaN(hiMJ)) {
┬а ┬а console.warn("тЪая╕П No valid Hi found for month:", monthIndex);
┬а ┬а return null;
┬а }


┬а ┬а const correction = 1.0;
┬а ┬а 
┬а ┬а
┬а ┬а const hiKWh = hiMJ * 0.27777778 * correction;

┬а ┬а
┬а ┬а console.log(`тШАя╕П Found Hi from "${matchedKey}" = ${hiMJ} MJ/m┬▓/day ├Ч 0.27778 ├Ч ${correction} = ${hiKWh.toFixed(2)} kWh/m┬▓/day`);
┬а ┬а return hiKWh;
}

┬а ┬а 
┬а ┬а function updateHi() {
┬а ┬а ┬а const p = document.getElementById("provinceInput").value;
┬а ┬а ┬а const d = document.getElementById("districtInput").value;
┬а ┬а ┬а const t = document.getElementById("tumbolInput").value;
┬а ┬а ┬а const m = document.getElementById("monthSelect").value;
┬а ┬а ┬а console.log("ЁЯФД updateHi triggered", { p, d, t, m });
┬а ┬а ┬а if (p && d && t && m !== "") {
┬а ┬а ┬а ┬а const hi = findHi(p, d, t, m === "all" ? "all" : parseInt(m));
┬а ┬а ┬а ┬а document.getElementById("hiResult").textContent =
┬а ┬а ┬а ┬а ┬а hi ? `р╕Др╣Ир╕▓ Hi (р╣Ар╕Йр╕ер╕╡р╣Ир╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ): ${hi.toFixed(2)} kWh/m┬▓` : "тЭМ р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щр╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е";
┬а ┬а ┬а }
┬а ┬а }

┬а ┬а
┬а ┬а document.getElementById("excelFile").addEventListener("change", e => {
┬а ┬а ┬а const file = e.target.files[0];
┬а ┬а ┬а if (!file) return;
┬а ┬а ┬а console.log("ЁЯУе Loading performance file:", file.name);
┬а ┬а ┬а const reader = new FileReader();
┬а ┬а ┬а reader.onload = event => {
┬а ┬а ┬а ┬а try {
┬а ┬а ┬а ┬а ┬а const data = new Uint8Array(event.target.result);
┬а ┬а ┬а ┬а ┬а const workbook = XLSX.read(data, { type: "array" });
┬а ┬а ┬а ┬а ┬а const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
┬а ┬а ┬а ┬а ┬а performanceData = XLSX.utils.sheet_to_json(firstSheet);
┬а ┬а ┬а ┬а ┬а console.log("тЬЕ Performance data loaded:", performanceData.length, "rows");
┬а ┬а ┬а ┬а ┬а document.getElementById("performanceStatus").textContent = `тЬЕ р╣Вр╕лр╕ер╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕е ${performanceData.length} р╣Бр╕Цр╕зр╣Бр╕ер╣Йр╕з`;
┬а ┬а ┬а ┬а ┬а document.getElementById("performanceStatus").classList.add("valid");
┬а ┬а ┬а ┬а } catch (err) {
┬а ┬а ┬а ┬а ┬а console.error("тЭМ Performance load error:", err);
┬а ┬а ┬а ┬а ┬а alert("р╣Вр╕лр╕ер╕Фр╣Др╕Яр╕ер╣М Performance р╣Др╕бр╣Ир╕кр╕│р╣Ар╕гр╣Зр╕И");
┬а ┬а ┬а ┬а }
┬а ┬а ┬а };
┬а ┬а ┬а reader.readAsArrayBuffer(file);
┬а ┬а });

┬а ┬а┬а
┬а ┬а
┬а ┬а document.getElementById("calcBtn").addEventListener("click", () => {
┬а ┬а ┬а console.log("ЁЯЪА Calculate button clicked");
┬а ┬а ┬а if (!performanceData.length) {
┬а ┬а ┬а ┬а alert("р╕Бр╕гр╕╕р╕Ур╕▓р╕нр╕▒р╕Ыр╣Вр╕лр╕ер╕Ф Performance File р╕Бр╣Ир╕нр╕Щ");
┬а ┬а ┬а ┬а return;
┬а ┬а ┬а }
┬а ┬а ┬а const selectedMonth = document.getElementById("monthSelect").value;
┬а ┬а ┬а 
┬а ┬а ┬а
┬а ┬а ┬а drawPRCharts(performanceData, selectedMonth);
┬а ┬а ┬а });

┬а ┬а 
┬а ┬а function drawPRCharts(allRows, selectedMonth) {
┬а ┬а ┬а console.log("ЁЯУИ drawPRCharts with", allRows.length, "rows", "for month", selectedMonth);
┬а ┬а ┬а try {
┬а ┬а ┬а ┬а const dailyLabels = [];
┬а ┬а ┬а ┬а const dailyPRs = [];
┬а ┬а ┬а ┬а const monthlyData = {}; 

┬а ┬а ┬а ┬а const p = document.getElementById("provinceInput").value;
┬а ┬а ┬а ┬а const d = document.getElementById("districtInput").value;
┬а ┬а ┬а ┬а const t = document.getElementById("tumbolInput").value;

┬а ┬а ┬а ┬а 
┬а ┬а ┬а ┬а const hiCache = {};
┬а ┬а ┬а ┬а for (let m = 0; m < 12; m++) {
┬а ┬а ┬а ┬а ┬а const hiVal = findHi(p, d, t, m);
┬а ┬а ┬а ┬а ┬а if (hiVal && !isNaN(hiVal)) hiCache[m] = hiVal;
┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а console.log("тШАя╕П Hi Cache (Daily Yr):", hiCache);

┬а ┬а ┬а ┬а 
┬а ┬а ┬а ┬а allRows.forEach((row, i) => {
┬а ┬а ┬а ┬а ┬а const normalizedRow = {};
┬а ┬а ┬а ┬а ┬а Object.keys(row).forEach(k => {
┬а ┬а ┬а ┬а ┬а ┬а normalizedRow[k.trim().replace(/\s+/g, " ")] = row[k];
┬а ┬а ┬а ┬а ┬а });

┬а ┬а ┬а ┬а ┬а const Po = parseFloat(String(normalizedRow["Po (kWp)"] || normalizedRow["Po"] || "").replace(/,/g, ""));
┬а ┬а ┬а ┬а ┬а const Egrid = parseFloat(String(normalizedRow["Egrid (kWh)"] || normalizedRow["E-Grid (kWh)"] || normalizedRow["Egrid"] || "").replace(/,/g, ""));
┬а ┬а ┬а ┬а ┬а const dateStr = normalizedRow["date"] || normalizedRow["р╕зр╕▒р╕Щр╕Чр╕╡р╣И"];
┬а ┬а ┬а ┬а ┬а if (!Po || !Egrid || !dateStr) {
┬а ┬а ┬а ┬а ┬а ┬а console.warn("тЪая╕П Skip row (missing Po/Egrid/date):", i, normalizedRow);
┬а ┬а ┬а ┬а ┬а ┬а return;
┬а ┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а ┬а const dObj = new Date(dateStr);
┬а ┬а ┬а ┬а ┬а if (isNaN(dObj)) return;

┬а ┬а ┬а ┬а ┬а const monthIndex = dObj.getMonth(); // 0тАУ11
┬а ┬а ┬а ┬а ┬а const Hi_this = hiCache[monthIndex]; // р╕Щр╕╡р╣Ир╕Др╕╖р╕н Yr (Daily Hi)
┬а ┬а ┬а ┬а ┬а if (!Hi_this || isNaN(Hi_this)) {
┬а ┬а ┬а ┬а ┬а ┬а console.warn("тЪая╕П No Hi for row:", i, "month=", monthIndex);
┬а ┬а ┬а ┬а ┬а ┬а return;
┬а ┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а ┬а const Yf = Egrid / Po;
┬а ┬а ┬а ┬а ┬а const Yr = Hi_this; // [FIXED] Yr р╕Др╕╖р╕нр╕Др╣Ир╕▓ Hi р╣Ар╕Йр╕ер╕╡р╣Ир╕вр╕гр╕▓р╕вр╕зр╕▒р╕Щ
┬а ┬а ┬а ┬а ┬а const PR = (Yf / Yr) * 100;

┬а ┬а ┬а ┬а ┬а if (isNaN(PR)) {
┬а ┬а ┬а ┬а ┬а ┬а console.warn("тЪая╕П PR is NaN:", { Yf, Yr, row });
┬а ┬а ┬а ┬а ┬а ┬а return;
┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а 
┬а ┬а ┬а ┬а ┬а // [FIXED] р╕Бр╕гр╕нр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕гр╕▓р╕Яр╕гр╕▓р╕вр╕зр╕▒р╕Щ
┬а ┬а ┬а ┬а ┬а if (selectedMonth === "all" || monthIndex === parseInt(selectedMonth)) {
┬а ┬а ┬а ┬а ┬а ┬а dailyLabels.push(dObj.toISOString().split("T")[0]);
┬а ┬а ┬а ┬а ┬а ┬а dailyPRs.push(PR);
┬а ┬а ┬а ┬а ┬а }

┬а ┬а ┬а ┬а ┬а // [FIXED] р╣Ар╕Бр╣Зр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕гр╕▓р╕Яр╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ (р╣Ар╕Бр╣Зр╕Ър╕Чр╕╕р╕Бр╣Ар╕Фр╕╖р╕нр╕Щр╣Ар╕кр╕бр╕н)
┬а ┬а ┬а ┬а ┬а const monthKey = `${dObj.getFullYear()}-${dObj.getMonth() + 1}`;
┬а ┬а ┬а ┬а ┬а if (!monthlyData[monthKey]) monthlyData[monthKey] = [];
┬а ┬а ┬а ┬а ┬а monthlyData[monthKey].push(PR);
┬а ┬а ┬а ┬а });

┬а ┬а ┬а ┬а console.log("тЬЕ Daily PR count (filtered):", dailyPRs.length);
┬а ┬а ┬а ┬а console.log("тЬЕ Monthly data keys (all):", Object.keys(monthlyData));

┬а ┬а ┬а ┬а // р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕│р╕лр╕гр╕▒р╕Ър╣Ар╕Фр╕╖р╕нр╕Щр╕Чр╕╡р╣Ир╣Ар╕ер╕╖р╕нр╕Бр╕лр╕гр╕╖р╕нр╣Др╕бр╣И (р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕гр╕▓р╕Яр╕гр╕▓р╕вр╕зр╕▒р╕Щ)
┬а ┬а ┬а ┬а if (dailyPRs.length === 0 && selectedMonth !== "" && selectedMonth !== "all") {
┬а ┬а ┬а ┬а ┬а alert("р╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Вр╕нр╕Зр╣Ар╕Фр╕╖р╕нр╕Щр╕Чр╕╡р╣Ир╣Ар╕ер╕╖р╕нр╕Бр╣Гр╕Щ Performance File");
┬а ┬а ┬а ┬а ┬а // р╕Чр╕│р╕ер╕▓р╕вр╕Бр╕гр╕▓р╕Яр╣Ар╕Бр╣Ир╕▓ (р╕Цр╣Йр╕▓р╕бр╕╡)
┬а ┬а ┬а ┬а ┬а if (dailyChart) dailyChart.destroy();
┬а ┬а ┬а ┬а } else {
┬а ┬а ┬а ┬а ┬а drawDailyChart(dailyLabels, dailyPRs);
┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а 
┬а ┬а ┬а ┬а // р╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕ер╕Вр╣Йр╕нр╕бр╕╣р╕ер╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ
┬а ┬а ┬а ┬а const monthlyLabels = Object.keys(monthlyData).sort((a, b) => new Date(a) - new Date(b)).map(key => {
┬а ┬а ┬а ┬а ┬а const [y, m] = key.split("-");
┬а ┬а ┬а ┬а ┬а return `${monthNames[m - 1]} ${y}`;
┬а ┬а ┬а ┬а });
┬а ┬а ┬а ┬а const monthlyPRs = Object.keys(monthlyData).sort((a, b) => new Date(a) - new Date(b)).map(key => {
┬а ┬а ┬а ┬а ┬а const arr = monthlyData[key];
┬а ┬а ┬а ┬а ┬а return arr.reduce((a, b) => a + b, 0) / arr.length;
┬а ┬а ┬а ┬а });

┬а ┬а ┬а ┬а console.log("тЬЕ Monthly PRs (calculated):", monthlyPRs);

┬а ┬а ┬а ┬а if (monthlyPRs.length > 0) {
┬а ┬а ┬а ┬а ┬а drawMonthlyChart(monthlyLabels, monthlyPRs);
┬а ┬а ┬а ┬а } else if (allRows.length > 0) {
┬а ┬а ┬а ┬а ┬а alert("р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕Др╕│р╕Щр╕зр╕У PR р╣Др╕Фр╣Й, р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щр╣Др╕Яр╕ер╣М Performance (р╣Ар╕Кр╣Ир╕Щ Po, Egrid, date)");
┬а ┬а ┬а ┬а ┬а if (monthlyChart) monthlyChart.destroy();
┬а ┬а ┬а ┬а }

┬а ┬а ┬а } catch (err) {
┬а ┬а ┬а ┬а console.error("тЭМ Error in drawPRCharts:", err, err.stack);
┬а ┬а ┬а ┬а alert("Error in drawPRCharts: " + err.message);
┬а ┬а ┬а }
┬а ┬а }


┬а ┬а // ===== CHARTS (р╕кр╣Ир╕зр╕Щр╕Щр╕╡р╣Йр╣Др╕бр╣Ир╕Хр╣Йр╕нр╕Зр╣Бр╕Бр╣Йр╣Др╕В) =====
┬а ┬а function drawDailyChart(labels, data) {
┬а ┬а ┬а console.log("ЁЯУК Drawing daily chart:", labels.length, "points");
┬а ┬а ┬а const ctx = document.getElementById("dailyChart").getContext("2d");
┬а ┬а ┬а if (dailyChart) dailyChart.destroy();
┬а ┬а ┬а dailyChart = new Chart(ctx, {
┬а ┬а ┬а ┬а type: 'line',
┬а ┬а ┬а ┬а data: {
┬а ┬а ┬а ┬а ┬а labels,
┬а ┬а ┬а ┬а ┬а datasets: [{
┬а ┬а ┬а ┬а ┬а ┬а label: 'PR р╕гр╕▓р╕вр╕зр╕▒р╕Щ (%)',
┬а ┬а ┬а ┬а ┬а ┬а data,
┬а ┬а ┬а ┬а ┬а ┬а borderColor: '#00A859',
┬а ┬а ┬а ┬а ┬а ┬а backgroundColor: 'rgba(0,168,89,0.15)',
┬а ┬а ┬а ┬а ┬а ┬а fill: true,
┬а ┬а ┬а ┬а ┬а ┬а tension: 0.35,
┬а ┬а ┬а ┬а ┬а ┬а pointRadius: 3,
┬а ┬а ┬а ┬а ┬а ┬а pointBackgroundColor: '#0072BC',
┬а ┬а ┬а ┬а ┬а ┬а borderWidth: 2
┬а ┬а ┬а ┬а ┬а }]
┬а ┬а ┬а ┬а },
┬а ┬а ┬а ┬а options: {
┬а ┬а ┬а ┬а ┬а plugins: {
┬а ┬а ┬а ┬а ┬а ┬а title: { display: true, text: 'Performance Ratio р╕гр╕▓р╕вр╕зр╕▒р╕Щ', font: { size: 16 } },
┬а ┬а ┬а ┬а ┬а ┬а legend: { display: false }
┬а ┬а ┬а ┬а ┬а },
┬а ┬а ┬а ┬а ┬а scales: {
┬а ┬а ┬а ┬а ┬а ┬а y: { beginAtZero: true, title: { display: true, text: 'PR (%)' } },
┬а ┬а ┬а ┬а ┬а ┬а x: { ticks: { maxRotation: 90, minRotation: 45 } }
┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а }
┬а ┬а ┬а });
┬а ┬а }

┬а ┬а function drawMonthlyChart(labels, data) {
┬а ┬а ┬а console.log("ЁЯУК Drawing monthly chart:", labels.length, "bars");
┬а ┬а ┬а const ctx = document.getElementById("monthlyChart").getContext("2d");
┬а ┬а ┬а if (monthlyChart) monthlyChart.destroy();
┬а ┬а ┬а const palette = [
┬а ┬а ┬а ┬а '#00A859', '#0072BC', '#9BCB3B', '#78BE20', '#006838', '#29ABE2', '#8DC63F', '#00573D'
┬а ┬а ┬а ];
┬а ┬а ┬а const colors = data.map((_, i) => palette[i % palette.length]);
┬а ┬а ┬а monthlyChart = new Chart(ctx, {
┬а ┬а ┬а ┬а type: 'bar',
┬а ┬а ┬а ┬а data: {
┬а ┬а ┬а ┬а ┬а labels,
┬а ┬а ┬а ┬а ┬а datasets: [{
┬а ┬а ┬а ┬а ┬а ┬а label: 'PR р╣Ар╕Йр╕ер╕╡р╣Ир╕вр╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ (%)',
┬а ┬а ┬а ┬а ┬а ┬а data,
┬а ┬а ┬а ┬а ┬а ┬а backgroundColor: colors,
┬а ┬а ┬а ┬а ┬а ┬а borderRadius: 6
┬а ┬а ┬а ┬а ┬а }]
┬а ┬а ┬а ┬а },
┬а ┬а ┬а ┬а options: {
┬а ┬а ┬а ┬а ┬а plugins: {
┬а ┬а ┬а ┬а ┬а ┬а title: { display: true, text: 'Performance Ratio р╣Ар╕Йр╕ер╕╡р╣Ир╕вр╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ', font: { size: 16 } },
┬а ┬а ┬а ┬а ┬а ┬а legend: { display: false }
┬а ┬а ┬а ┬а ┬а },
┬а ┬а ┬а ┬а ┬а scales: {
┬а ┬а ┬а ┬а ┬а ┬а y: { beginAtZero: true, title: { display: true, text: 'PR (%)' } }
┬а ┬а ┬а ┬а ┬а }
┬а ┬а ┬а ┬а }
┬а ┬а ┬а });
┬а ┬а }

┬а ┬а document.getElementById("tumbolInput").addEventListener("input", updateHi);
┬а ┬а document.getElementById("monthSelect").addEventListener("change", updateHi);
┬а </script>

</body>

</html>